#!/bin/bash

available() {
  command -v $1 > /dev/null
}

select_container_manager() {
  if available podman; then
    CONMAN="podman"
  elif available docker; then
    CONMAN="docker"
  else
    CONMAN="podman"
  fi
}

# Function to create directory and Containerfile
generate_containerfile() {
  local model_dir="$(echo $1 | tr '[:upper:]' '[:lower:]')"
  local hf_repo=$2
  local model_file=$3

  mkdir -p "container-images/$model_dir"

  cat <<EOF > "container-images/$model_dir/Containerfile"
FROM podman-llm/podman-llm:41

RUN llama-cpp-main --hf-repo $hf_repo -m $model_file

ENTRYPOINT ["llama-cpp-main", "-m", "/$model_file", "--log-disable"]
CMD ["--instruct"]
EOF
}

generate_containerfiles() {
  # Iterate over the models and generate Containerfiles
  for model_dir in "${!models[@]}"; do
    IFS=' ' read -r -a model_info <<< "${models[$model_dir]}"
    hf_repo=${model_info[0]}
    model_file=${model_info[1]}

    generate_containerfile "$model_dir" "$hf_repo" "$model_file"
  done

  echo "Containerfiles have been generated successfully."
}

# Function to check and replace model names
replace_model() {
  local prefix="quay.io/podman-llm"
  local arg=$1
  for model in "${run_models[@]}"; do
    if [[ "$arg" == "$model" ]]; then
      echo "$prefix/$arg"
      return
    fi
  done

  echo "$arg"
}


main() {
  set -e -o pipefail

  select_container_manager

  declare -A hf_repos
  declare -A model_files
  while read -r id hf_repo model_file; do
    hf_repos["$id"]="$hf_repo"
    model_files["$id"]="$model_file"
  done <<< "$(curl -fsSL https://raw.githubusercontent.com/ericcurtin/podman-llm/test/hf-db.txt)"

  new_args=()

  # Loop through all arguments and replace them if necessary
  for arg in "$1"; do
    if [ -n "${hf_repos[$1]}" ]; then
      tag="podman-llm/$1"

      containerfile="$(cat <<-END
FROM quay.io/podman-llm/podman-llm:41

RUN llama-cpp-main --hf-repo ${hf_repos[$1]} -m ${model_files[$1]}

ENTRYPOINT ["llama-cpp-main", "-m", "/${model_files[$1]}", "--log-disable"]
CMD ["--instruct"]
END

)"

      if [ -z "$($CONMAN images -q $tag 2> /dev/null)" ]; then
        echo "$containerfile" | $CONMAN build -t $tag -
      fi

      new_args+=("$tag")
    else
      new_args+=("$arg")
    fi
  done

  # Update the positional parameters
  set -- "${new_args[@]}"

  if [ "$1" = "run" ]; then
    shift 1
    $CONMAN run --rm -it --security-opt=label=disable -v"$HOME":"$HOME" -v/tmp:/tmp "$@"
    return 0
  fi

  podman "$@"
}

main "$@"

